# Rank System 仕様書（rank.py）

**対象モジュール:** rank.py  
**バージョン:** 1.14.0  
**最終更新:** 2026年1月  
**対象読者:** コミュニティマネージャー、コミュニティイノベーター、Bot開発者  

---

## 1. 背景

本ランクシステムは、サーバー内のアクティビティを可視化し、  
メンバーの継続的な参加を促進することを目的として設計される。  

テキストチャンネルおよび VC（ボイスチャンネル）の双方を評価対象とすることで、  
発言量や通話参加など多様な活動が正しく反映される仕組みとする。

---

## 2. EXP システム概要

### 2.1 EXP 付与源

- テキスト / VC の EXP 比率は **1:1** を初期値とする  
- 管理コマンドにより、付与量・比率はすべて変更可能

### 2.2 VC EXP 設計（放置対策）

- Bot を除き **2 人以上**が VC に参加している場合のみ EXP を付与
- 1 人のみの場合は付与しない

---

## 3. レベル・EXP 設計

### 3.1 レベルごとの必要 EXP

- 各レベルで必要 EXP は **40 EXP 刻み**で増加
- 例：
  - Lv.1 → 40 EXP
  - Lv.10 → 400 EXP
  - Lv.50 → 2000 EXP

### 3.2 レベル増加量

| レベル | 必要 EXP |
|------|----------|
| 1 | 40 |
| 2 | 80 |
| 3 | 120 |
| 4 | 160 |
| 5 | 200 |

---

## 4. ランクロール仕様

### 4.1 ランクロール一覧

| 到達Lv | ロール名 |
|------|---------|
| 0 | なし |
| 1 | 🔰｜見習い隊士 |
| 5 | 🌸｜慣れてきた隊士 |
| 10 | 🌱｜一人前の隊士 |
| 20 | 🛡｜熟練隊士 |
| 30 | ⚔｜歴戦隊士 |
| 40 | 🏅｜精鋭隊士 |
| 50 | 👑｜上級隊士 |
| 75 | 🌟｜伝説級隊士 |
| 100 | 🏆｜殿堂入り隊士 |

※ ロールが存在しない場合は Bot が自動生成し付与する

### 4.2 ロール色・序列

- ロール色：灰色（初期色）

**ロール階層（上 → 下）**
```
運営ロール
ランクロール
Botロール
メンバーロール
オフライン・その他
```

- Bot は **自身のロールより上位のロールを操作しない**
- OfficialBot ロールは表示しないが、ランクロールより上位に配置される

---

## 5. ランクアップ通知

- 通知チャンネル ID は `.env` から取得
- 基本はメンションあり
- ユーザー設定によりメンション無効化が可能

---

## 6. ランクロール変更ログ

### 6.1 ログ出力条件

- Lv.1 / 5 / 10 / 20 / 30 / 40 / 50 / 75 / 100 到達時
- EXP 増加のみの場合は出力しない

### 6.2 ログ内容

- 対象ユーザー
- 変更前ランク / 変更後ランク
- 付与ロール
- 変更理由（定型文）
- 実行日時

---

## 7. 権限不足時の挙動

### 7.1 概要

Bot がロール操作に必要な権限を持たない場合、  
処理を中断し、必ず運営に通知する。

### 7.2 通知仕様

- ログチャンネル ID：`.env` から取得
- サーバーオーナー ID：`.env` から取得しメンション
- Embed 形式で送信

---

## 8. /rank グループコマンド

### 8.1 /rank

- 自分、または指定 user のランクを画像生成で表示
- BG 画像はコード上部でパス指定

### 8.2 /rank leaderboard

- type: normal / weekly
- 上位 10 位を Embed で表示
- 0 EXP ユーザーは除外

---

## 9. 環境変数（.env）

- LOG_CHANNEL_ID
- OWNER_ID
- RANK_NOTIFICATION_CHANNEL_ID
- 各ランクロール ID

---

## 10. 免責事項

本仕様は、特定の外部 Bot やサービスの UI を模倣することを目的としない。  
一般的なランキング表現を参考に、独自仕様として設計される。

Discord API の変更等により、挙動が変化する可能性がある。
