# Bot v1.14 アップデートガイド

## 新機能: Web Hook送信システム

### 概要
v1.14では、Discord Web Hookを使用したメッセージ転送システムが追加されました。
運営スタッフが質問対応などを行う際に、事前に設定したWeb Hookの名前とアバターを使用してメッセージを送信できます。

### 主な特徴
- **シンプルな対話型フロー**: メッセージIDのみ入力
- **.envファイルで一元管理**: Web Hook URLを安全に管理
- **Discord UIで設定**: 名前、アバター、送信先チャンネルはDiscord側で管理
- **メッセージプレビュー**: 送信前に内容を確認
- **リアルタイムログ表示**: 処理状況を疑似ターミナルで確認
- **即時メッセージ削除**: プライバシー保護のため、入力したIDなどは即座に削除
- **フォーラム/スレッド対応**: 通常のチャンネルだけでなく、フォーラムやスレッド内のメッセージも送信可能

---

## インストール手順

### 1. ファイルの配置
`webhook_sender.py` を Bot のディレクトリに配置してください。

```
your-bot/
├── bot.py (またはmain.py)
├── .env               # ← Web Hook URL設定ファイル
├── webhook_sender.py  # ← 新規追加
└── cogs/
```

### 2. .envファイルの設定

プロジェクトのルートディレクトリに `.env` ファイルを作成し、Web Hook URLを設定します：

```env
#  <---Discord Bot--->
DISCORD_BOT_TOKEN=
CM_ROLE_ID=
SENDER_WEBHOOK_URL=
```

**⚠️ 重要:** 
- `.env` ファイルは `.gitignore` に追加して、Gitにコミットしないようにしてください！
- `CM_ROLE_ID`を設定すると、そのロールを持つユーザーのみがコマンドを使用できます

```.gitignore
.env
venv
venv/*
data/
data/*
SSP/codes/
SSP/codes/*
__pycache__/
*.pyc
*.pyo
*.pyd
__init__.py
.DS_Store
```

### 3. Web Hookの作成と設定

#### Web Hookの作成手順

1. **送信先チャンネルでWeb Hookを作成**
   - 送信先にしたいチャンネルの設定を開く
   - 連携サービス → ウェブフック
   - 「新しいウェブフック」をクリック

2. **名前とアバターを設定**
   - 名前: 例）`運営質問担当`、`面接担当者` など
   - アバター: 運営用のアイコン画像をアップロード
   - これらの設定が送信時に使用されます

3. **Web Hook URLをコピー**
   - 「ウェブフックURLをコピー」をクリック
   - `.env` ファイルの `SENDER_WEBHOOK_URL` に貼り付け

4. **保存**
   - 「変更を保存」をクリック

**重要:** Web Hookを作成したチャンネルが送信先になります。送信先を変更したい場合は、Discord UIでWeb Hookのチャンネルを変更してください。

#### Web Hookの送信先チャンネルを変更する方法

1. チャンネル設定 → 連携サービス → ウェブフック
2. 編集したいWeb Hookをクリック
3. 「チャンネル」ドロップダウンから新しい送信先を選択
4. 「変更を保存」

### 4. 必要なライブラリのインストール

以下のライブラリが必要です：

```bash
pip install -r requirements.txt
```

requirements.txt に追加する場合：
```
discord.py>=2.0.0
aiohttp>=3.8.0
python-dotenv>=1.0.0
```

### 5. メインファイルへの統合

**bot.py (またはmain.py)** に以下のコードを追加してください：

```python
import discord
from discord.ext import commands
import os
from dotenv import load_dotenv

# .envファイルを読み込む
load_dotenv()

# Botの設定
intents = discord.Intents.default()
intents.message_content = True
intents.guilds = True  # ← スレッド/フォーラム対応に必要
intents.messages = True  # ← スレッド/フォーラム対応に必要

bot = commands.Bot(command_prefix='!', intents=intents)

# Cogのロード
async def load_extensions():
    await bot.load_extension('webhook_sender')

@bot.event
async def on_ready():
    await load_extensions()
    print(f'{bot.user} がログインしました')

# Botを起動
bot.run(os.getenv('DISCORD_TOKEN'))
```

---

## 使用方法

### 基本的な流れ

1. **コマンドの実行**
   ```
   WH送信
   ```
   → メッセージがすぐに削除され、「送信するメッセージIDを送信してください」と表示

2. **メッセージIDの入力**
   ```
   1234567890123456789
   ```
   → メッセージと案内文がすぐに削除され、「処理中...」と表示

3. **処理完了**
   ```
   ✅処理完了！
   ```
   → 0.5秒後に確認画面が表示

4. **確認画面**
   ```
   @ユーザー
   **以下の内容で送信します。送信しますか？**

   📝 **名前:** `運営質問担当`
   🖼️ **アバター:** https://...
   📢 **送信先チャンネル:** <#1234...>

   **送信されるメッセージ:**
   > こんにちは！運営です。
   > ご質問ありがとうございます。
   📎 添付ファイル: 1個

   ```
   待機中...
   ```

   [はい] [いいえ]
   ```

5. **送信実行**
   - 「はい」ボタンをクリックすると送信が開始されます
   - リアルタイムでログが更新されます
   - 送信完了後も確認画面は残ります（ログ確認用）

### リアルタイムログの見方

「はい」をクリックすると、コードブロック内にログが表示されます：

```
[DEBUG] メッセージID 1234567890123456789 を検索中...
[DEBUG] メッセージを発見: スレッド 🎫 ticket-0001 (ID: 1234567890123456789)
[DEBUG] 50 個のチャンネル、10 個のスレッドを検索しました
[DEBUG] Web Hookで送信中...
[DEBUG] 送信が完了しました！
```

### 即時メッセージ削除について

このシステムでは、以下のタイミングでメッセージが削除されます：

| アクション | 削除されるもの |
|-----------|---------------|
| 「WH送信」と入力 | → すぐに削除 |
| メッセージID入力 | → ユーザーのメッセージと前の案内文がすぐに削除 |
| 確認画面表示 | → 送信完了後も残る（ログ確認用）|

**メリット:**
- ✅ チャンネルが常にクリーン
- ✅ プライバシー保護（IDが残らない）
- ✅ 複数人が同時使用しても混乱しない
- ✅ 送信履歴をログで確認できる

**注意**: メッセージ削除には「メッセージを管理」権限が必要です。

### IDの取得方法

**メッセージIDの取得:**
1. Discord の設定 → 詳細設定 → 開発者モードをON
2. メッセージを右クリック → IDをコピー

---

## 運営募集での使用例

### シナリオ: 質問対応スタッフとしての使用

#### 準備
1. 質問受付チャンネルでWeb Hookを作成
2. 名前を「運営質問担当」、アバターに運営ロゴを設定
3. Web Hook URLを`.env`ファイルの`SENDER_WEBHOOK_URL`に設定

#### 実際の使用
1. 運営用チャンネルまたはフォーラムのスレッドで応募者への返信メッセージを作成
2. そのメッセージのIDをコピー
3. 任意のチャンネルで `WH送信` と入力（すぐ消える）
4. メッセージIDを入力（すぐ消える）
5. 「処理中...」→「✅処理完了！」
6. 確認画面でメッセージプレビューを確認
7. 「はい」をクリック
8. → ログを確認しながら送信完了
9. 「運営質問担当」名義で返信が送信される

---

## 対応するメッセージの種類

このシステムは以下のすべての種類のメッセージに対応しています：

- ✅ 通常のテキストチャンネル内のメッセージ
- ✅ テキストチャンネル内のスレッドのメッセージ
- ✅ フォーラムチャンネル内のスレッドのメッセージ
- ✅ プライベートスレッドのメッセージ（権限がある場合）
- ✅ テキストのみ、画像付き、Embed付き、すべてに対応

---

## 必要な権限

Botに以下の権限が必要です：

- ✅ メッセージを読む
- ✅ メッセージ履歴を読む
- ✅ ウェブフックを管理（情報取得のみ）
- ✅ メッセージを送信
- ✅ **メッセージを管理**（即時削除機能に必要）

**権限の確認方法:**
1. サーバー設定 → ロール
2. Botのロールを選択
3. 上記の権限がすべてONになっているか確認

---

## エラー対処

### よくあるエラー

**❌ 無効なメッセージIDです**
- 原因: 数字以外の文字が含まれている
- 対処: 数字のみで構成されたIDを入力してください

**⚠️ 警告: SENDER_WEBHOOK_URLが.envファイルに設定されていません**
- 原因: `.env` ファイルに `SENDER_WEBHOOK_URL` が設定されていない
- 対処: `.env` ファイルに `SENDER_WEBHOOK_URL=...` を追加してください

**⚠️ 警告: CM_ROLE_IDが.envファイルに設定されていません**
- 原因: `.env` ファイルに `CM_ROLE_ID` が設定されていない
- 影響: 誰でもコマンドを使用できる状態になります（非推奨）
- 対処: `.env` ファイルに `CM_ROLE_ID=...` を追加してください

**WH送信と入力しても何も起こらない**
- 原因: 権限がない（CM_ROLE_IDで指定されたロールを持っていない）
- 対処: サーバー管理者に連絡して、必要なロールを付与してもらってください
- 注意: これは正常な動作です（セキュリティのため）

**❌ 指定されたメッセージが見つかりませんでした**
- 原因: メッセージIDが間違っているか、Botがアクセスできない
- 対処: 
  - メッセージIDを確認
  - Botにメッセージ履歴を読む権限があるか確認
  - フォーラムのスレッドの場合、スレッドがアーカイブされていないか確認

**[DEBUG] 0 個のスレッドを検索しました**
- 原因: スレッドが検索されていない
- 対処: bot.pyのIntentsに`guilds=True`と`messages=True`を追加

---

## セキュリティに関する注意

### 1. .envファイルの管理
- `.env` ファイルは絶対にGitにコミットしないでください
- `.gitignore` に `.env` を追加してください
- Web Hook URLは機密情報として扱ってください

### 2. Web Hook URLの取り扱い
- Web Hook URLを知っている人は、誰でもそのWeb Hookを使用してメッセージを送信できます
- 不要になったWeb Hookは必ず削除してください
- Web Hook URLが漏洩した場合は、すぐに削除して新しく作成してください

### 3. 権限の制限（設定済み）

このシステムでは、`.env`ファイルの`CM_ROLE_ID`で指定したロールを持つユーザーのみがコマンドを使用できます。

**設定方法:**

1. **ロールIDの取得**
   - Discord でロールを右クリック → IDをコピー

2. **.envファイルに追加**
   ```env
   CM_ROLE_ID=1234567890  # ← コピーしたロールIDを貼り付け
   ```

3. **Botを再起動**
   - 設定を反映させるため、Botを再起動してください

**動作:**
- `CM_ROLE_ID`が設定されている場合: そのロールを持つユーザーのみ使用可能
- `CM_ROLE_ID`が設定されていない場合: 誰でも使用可能（⚠️ 非推奨）

**権限がないユーザーが使用した場合:**
- 「WH送信」メッセージが即座に削除される
- 何も表示されない（静かに拒否）

---

## カスタマイズ

### 1. コマンドトリガーの変更

```python
# 🔍 webhook_sender.py の272行目付近を探す
        if message.content == "WH送信":

# ✏️ 以下のように変更
        if message.content == "!webhook":  # ← お好みのコマンドに変更
```

### 2. タイムアウトの変更

```python
# 🔍 webhook_sender.py の15行目付近を探す
        super().__init__(timeout=300)

# ✏️ 秒数を変更
        super().__init__(timeout=600)  # ← 10分に変更
```

### 3. プレビューの文字数制限を変更

```python
# 🔍 webhook_sender.py の380行目付近を探す
                    if len(preview_content) > 500:
                        preview_content = preview_content[:500] + "..."

# ✏️ 文字数を変更
                    if len(preview_content) > 1000:  # ← 1000文字に変更
                        preview_content = preview_content[:1000] + "..."
```

---

## トラブルシューティング

### Q1: Web Hookの名前やアバターが反映されない
**A:** Web Hookの設定を変更した場合、Botを再起動してください。また、Discord側のキャッシュが原因の場合もあるため、数分待ってから試してください。

### Q2: 送信先チャンネルを変更したい
**A:** Discord UIでWeb Hookのチャンネル設定を変更してください：
1. チャンネル設定 → 連携サービス → ウェブフック
2. Web Hookを編集
3. 「チャンネル」ドロップダウンから新しい送信先を選択
4. 変更を保存

### Q3: フォーラムのメッセージが見つからない
**A:** 
- bot.pyの`intents`に`guilds=True`と`messages=True`が追加されているか確認
- フォーラムのスレッドがアーカイブされていないか確認
- スレッドを開いてアクティブ化してから再試行

### Q4: 処理に時間がかかる
**A:** チャンネル数やスレッド数が多い場合、メッセージ検索に時間がかかります。これは正常な動作です。「処理中...」表示で進行状況を確認できます。

### Q5: 確認画面が消えてしまう
**A:** v1.14では、送信完了後も確認画面は残るようになっています。古いバージョンを使用している場合は、最新版に更新してください。

---

## 更新履歴

### v1.14.0 γ (2025-02-15)
- **新機能**: 処理中表示の追加
  - 「処理中...」→「✅処理完了！」の表示
  - ユーザーエクスペリエンスの向上
- **改善**: 確認画面を送信後も保持
  - ログ確認用に残す仕様に変更
  - ボタンは送信/キャンセル後に無効化

### v1.14.0 β (2025-02-14)
- **変更**: チャンネルID入力フローを削除
- **改善**: 即時メッセージ削除機能を強化
- **追加**: フォーラム/スレッド対応

### v1.14.0 α (2025-02-14)
- **バグ修正**: `NoneType has no len()` エラーを修正
- **新機能**: 自動メッセージ削除機能を追加

### v1.14.0 (2025-02-14)
- Web Hook送信システムの初回リリース

---

## FAQ（よくある質問）

**Q: フォーラムのメッセージも送信できますか？**
A: はい、v1.14.2以降、フォーラムチャンネル内のスレッドにも対応しています。

**Q: 送信履歴は確認できますか？**
A: はい、確認画面のログで確認できます。送信完了後もログが表示されます。

**Q: 複数のWeb Hookを使い分けたい**
A: `.env`ファイルに複数のURLを設定し、コードを修正することで対応できます。

**Q: 処理中の表示を無効にしたい**
A: webhook_sender.pyの該当部分をコメントアウトしてください。

---

## サポート

問題が発生した場合は、以下を確認してください：

1. ✅ Discord.pyのバージョン（2.0以降が必要）
2. ✅ Botの権限設定（特に「メッセージを管理」）
3. ✅ .envファイルの`SENDER_WEBHOOK_URL`設定
4. ✅ bot.pyのIntents設定（`guilds=True`, `messages=True`）
5. ✅ Web Hookの存在確認（Discord UI）
6. ✅ ログに表示されるエラー内容

それでも解決しない場合は、確認画面のログ内容とともに開発チームにお問い合わせください。